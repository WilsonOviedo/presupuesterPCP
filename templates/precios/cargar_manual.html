{% extends 'base.html' %}
{% block title %}Cargar Precios Manualmente{% endblock %}
{% block head %}
  <style>
    .form-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .form-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .form-section h3 {
      margin-top: 0;
      color: #333;
    }
    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .form-row label {
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
    }
    .form-row input {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .items-container {
      margin-top: 20px;
    }
    .item-row {
      display: grid;
      grid-template-columns: 2fr 1fr auto;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .item-row input {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .item-row .remove-btn {
      padding: 8px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .item-row .remove-btn:hover {
      background: #d32f2f;
    }
    .add-item-btn {
      padding: 10px 20px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    .add-item-btn:hover {
      background: #45a049;
    }
    .submit-section {
      margin-top: 30px;
      display: flex;
      gap: 10px;
    }
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #ef5350;
    }
    .info-box {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #90caf9;
    }
    .info-box h4 {
      margin-top: 0;
      color: #1976d2;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="form-container">
    <div style="margin-bottom: 20px;">
      <a class="button button-secondary" href="{{ url_for('precios_index') }}">‚Üê Volver a Precios</a>
    </div>

    <h2>Cargar Precios Manualmente</h2>

    {% if error %}
      <div class="error-message">
        <strong>Error:</strong> {{ error }}
      </div>
    {% endif %}

    <div class="info-box">
      <h4>üìã Formato de Carga</h4>
      <p>Los precios se guardar√°n con el mismo formato que cuando se cargan desde IMAP:</p>
      <ul>
        <li><strong>Proveedor:</strong> Nombre del proveedor (se convertir√° a may√∫sculas)</li>
        <li><strong>Fecha:</strong> Selecciona la fecha del precio (si no se especifica, se usar√° la fecha actual)</li>
        <li><strong>Hora:</strong> Ingresa solo la hora (0-23). Ejemplo: si ingresas "13", se guardar√° como "13:00:00"</li>
        <li><strong>Producto:</strong> Nombre del producto (se convertir√° a may√∫sculas)</li>
        <li><strong>Precio:</strong> Valor num√©rico (puede usar punto o coma como separador decimal)</li>
      </ul>
      <p><small>Nota: Si un precio ya existe (mismo proveedor, fecha, producto y precio), no se duplicar√°.</small></p>
    </div>

    <form method="POST" action="{{ url_for('precios_cargar_manual') }}" id="preciosForm">
      <div class="form-section">
        <h3>Informaci√≥n General</h3>
        <div class="form-row" style="grid-template-columns: 2fr 1fr 1fr;">
          <div>
            <label for="proveedor">Proveedor:</label>
            <input type="text" id="proveedor" name="proveedor" 
                   placeholder="Ej: EVEREST, PROVEEDOR X" 
                   value="{{ request.form.get('proveedor', '') or '' }}"
                   required
                   style="width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px;">
            <small style="display: block; margin-top: 5px; color: #666;">Ingresa el nombre del proveedor (se convertir√° a may√∫sculas)</small>
          </div>
          <div>
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" name="fecha" 
                   value="{{ request.form.get('fecha', '') or '' }}">
            <small style="display: block; margin-top: 5px; color: #666;">Si no se especifica, se usar√° la fecha actual</small>
          </div>
          <div>
            <label for="hora">Hora:</label>
            <input type="text" id="hora" name="hora" placeholder="HH (ej: 13)" 
                   pattern="^([0-1]?[0-9]|2[0-3])$" maxlength="2"
                   value="{{ request.form.get('hora', '') or '' }}">
            <small style="display: block; margin-top: 5px; color: #666;">Solo hora (0-23), se completar√° a HH:00</small>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h3>Items (Productos y Precios)</h3>
        <div class="items-container" id="itemsContainer">
          <!-- Los items se agregar√°n din√°micamente aqu√≠ -->
        </div>
        <button type="button" class="add-item-btn" id="addItemBtn">‚ûï Agregar Item</button>
      </div>

      <div class="submit-section">
        <button type="submit" class="button" style="background: #2196F3;">üíæ Guardar Precios</button>
        <a href="{{ url_for('precios_index') }}" class="button button-secondary">Cancelar</a>
      </div>
    </form>
  </div>
{% endblock %}
{% block scripts %}
  <script>
    (function() {
      let itemCount = 0;
      const itemsContainer = document.getElementById('itemsContainer');
      const addItemBtn = document.getElementById('addItemBtn');
      const form = document.getElementById('preciosForm');

      function addItemRow(producto = '', precio = '') {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.dataset.itemIndex = itemCount;

        row.innerHTML = `
          <input type="text" name="producto_${itemCount}" placeholder="Nombre del producto" 
                 value="${producto}">
          <input type="text" name="precio_${itemCount}" placeholder="Precio (ej: 100.50)" 
                 value="${precio}" pattern="[0-9]+([.,][0-9]+)?">
          <button type="button" class="remove-btn" onclick="removeItem(this)">‚úï</button>
        `;

        itemsContainer.appendChild(row);
        itemCount++;

        // Auto-focus en el campo de producto
        const productoInput = row.querySelector('input[name^="producto"]');
        if (productoInput) {
          setTimeout(() => productoInput.focus(), 50);
        }
      }

      function removeItem(btn) {
        const row = btn.closest('.item-row');
        if (row) {
          row.remove();
        }
      }

      // Agregar primer item al cargar
      addItemRow();

      // Agregar item al hacer clic
      addItemBtn.addEventListener('click', () => {
        addItemRow();
      });

      // Manejar Enter en campos de precio para agregar nuevo item
      itemsContainer.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          const precioInput = e.target;
          if (precioInput.name && precioInput.name.startsWith('precio_')) {
            e.preventDefault();
            const row = precioInput.closest('.item-row');
            const productoInput = row.querySelector('input[name^="producto"]');
            
            // Validar que ambos campos tengan valor
            if (productoInput.value.trim() && precioInput.value.trim()) {
              addItemRow();
            } else {
              // Si falta producto, enfocar ese campo
              if (!productoInput.value.trim()) {
                productoInput.focus();
              }
            }
          }
        }
      });

      // Formatear n√∫meros al perder foco
      itemsContainer.addEventListener('blur', function(e) {
        if (e.target.name && e.target.name.startsWith('precio_')) {
          let value = e.target.value.trim();
          if (value) {
            // Reemplazar coma por punto
            value = value.replace(',', '.');
            // Validar que sea un n√∫mero
            const num = parseFloat(value);
            if (!isNaN(num)) {
              e.target.value = num.toFixed(2);
            }
          }
        }
      }, true);

      // Formatear hora al perder foco
      const horaInput = document.getElementById('hora');
      if (horaInput) {
        horaInput.addEventListener('blur', function() {
          let value = this.value.trim();
          if (value) {
            // Validar que sea un n√∫mero entre 0 y 23
            const hora = parseInt(value);
            if (!isNaN(hora) && hora >= 0 && hora <= 23) {
              // Formatear con 2 d√≠gitos
              this.value = hora.toString().padStart(2, '0');
            } else {
              // Si no es v√°lido, limpiar
              this.value = '';
            }
          }
        });

        // Validar mientras se escribe
        horaInput.addEventListener('input', function() {
          let value = this.value.trim();
          // Solo permitir n√∫meros
          this.value = value.replace(/[^0-9]/g, '');
          // Limitar a 2 d√≠gitos
          if (this.value.length > 2) {
            this.value = this.value.substring(0, 2);
          }
          // Validar rango mientras se escribe
          if (this.value) {
            const hora = parseInt(this.value);
            if (hora > 23) {
              this.value = '23';
            }
          }
        });
      }

      // Validar formulario antes de enviar
      // Solo verificar que haya al menos un item v√°lido, ignorar l√≠neas vac√≠as
      form.addEventListener('submit', function(e) {
        const items = itemsContainer.querySelectorAll('.item-row');
        let hasValidItem = false;
        let emptyItems = 0;

        items.forEach(row => {
          const producto = row.querySelector('input[name^="producto"]').value.trim();
          const precio = row.querySelector('input[name^="precio"]').value.trim();
          
          if (producto && precio) {
            hasValidItem = true;
          } else if (!producto && !precio) {
            emptyItems++;
          }
          // Si solo tiene uno de los dos campos, se ignorar√° en el backend
        });

        if (!hasValidItem) {
          e.preventDefault();
          alert('Por favor, ingresa al menos un producto con su precio completo. Las l√≠neas vac√≠as se ignorar√°n autom√°ticamente.');
          return false;
        }
        
        // Si hay items vac√≠os, informar pero permitir continuar
        if (emptyItems > 0 && hasValidItem) {
          // No prevenir el env√≠o, solo informar (opcional)
          // Las l√≠neas vac√≠as se ignorar√°n autom√°ticamente en el backend
        }
      });
    })();
  </script>
{% endblock %}


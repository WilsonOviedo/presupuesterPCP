{% extends 'base.html' %}
{% block title %}Cargar Proveedores{% endblock %}
{% block head %}
  <style>
    .form-container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .info-box {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #90caf9;
    }
    .success-box {
      background: #d4edda;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .error-box {
      background: #ffebee;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #ef5350;
      color: #c62828;
    }
    .proveedores-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .proveedores-section h3 {
      margin-top: 0;
      color: #333;
    }
    .proveedores-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      background: white;
    }
    .proveedor-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .proveedor-item:last-child {
      border-bottom: none;
    }
    .proveedor-item input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .proveedor-item label {
      flex: 1;
      cursor: pointer;
      margin: 0;
      font-weight: normal;
    }
    .select-all-controls {
      margin-bottom: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 4px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .stat-item {
      padding: 10px 15px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .stat-item strong {
      display: block;
      font-size: 1.2em;
      color: #2196F3;
    }
    .stat-item span {
      color: #666;
      font-size: 0.9em;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="form-container">
    <div style="margin-bottom: 20px;">
      <a class="button button-secondary" href="{{ url_for('precios_index') }}">‚Üê Volver a Precios</a>
    </div>

    <h2>Cargar Proveedores desde Tabla de Precios</h2>

    {% if mensaje %}
      <div class="success-box">
        <strong>‚úÖ √âxito:</strong> {{ mensaje }}
      </div>
    {% endif %}

    {% if error %}
      <div class="error-box">
        <strong>‚ùå Error:</strong> {{ error }}
      </div>
    {% endif %}

    <div class="info-box">
      <h4>üìã Informaci√≥n</h4>
      <p>Esta p√°gina extrae todos los proveedores √∫nicos de la tabla <code>precios</code> y te permite cargarlos en la tabla <code>proveedores</code>.</p>
      <ul>
        <li>Los proveedores se muestran sin duplicados (case-insensitive)</li>
        <li>Los proveedores que ya existen en la tabla <code>proveedores</code> se muestran separados</li>
        <li>Puedes seleccionar todos o algunos proveedores para cargar</li>
        <li>Los nombres se convertir√°n autom√°ticamente a may√∫sculas</li>
      </ul>
    </div>

    <div class="stats">
      <div class="stat-item">
        <strong>{{ total_nuevos }}</strong>
        <span>Proveedores nuevos</span>
      </div>
      <div class="stat-item">
        <strong>{{ total_existentes }}</strong>
        <span>Ya en base de datos</span>
      </div>
    </div>

    {% if proveedores_nuevos %}
      <form method="POST" action="{{ url_for('precios_cargar_proveedores') }}" id="proveedoresForm">
        <div class="proveedores-section">
          <h3>Proveedores Nuevos ({{ total_nuevos }})</h3>
          <p style="color: #666; margin-bottom: 10px;">Selecciona los proveedores que deseas cargar en la tabla <code>proveedores</code>:</p>
          
          <div class="select-all-controls">
            <button type="button" class="button button-secondary" onclick="selectAll()">‚úì Seleccionar Todos</button>
            <button type="button" class="button button-secondary" onclick="deselectAll()">‚úó Deseleccionar Todos</button>
            <span style="margin-left: auto; color: #666;">
              <span id="selectedCount">0</span> seleccionados
            </span>
          </div>
          
          <div class="proveedores-list">
            {% for proveedor in proveedores_nuevos %}
              <div class="proveedor-item">
                <input type="checkbox" 
                       name="proveedores" 
                       value="{{ proveedor }}" 
                       id="prov_{{ loop.index }}"
                       onchange="updateSelectedCount()">
                <label for="prov_{{ loop.index }}">{{ proveedor }}</label>
              </div>
            {% endfor %}
          </div>
        </div>

        <div style="margin-top: 20px;">
          <button type="submit" class="button" style="background: #4CAF50; padding: 12px 24px; font-size: 1.1em;">
            üíæ Cargar Proveedores Seleccionados
          </button>
          <a href="{{ url_for('precios_index') }}" class="button button-secondary">Cancelar</a>
        </div>
      </form>
    {% else %}
      <div class="info-box">
        <p>No hay proveedores nuevos para cargar. Todos los proveedores de la tabla <code>precios</code> ya est√°n en la tabla <code>proveedores</code>.</p>
      </div>
    {% endif %}

  </div>
{% endblock %}
{% block scripts %}
  <script>
    function selectAll() {
      const checkboxes = document.querySelectorAll('input[name="proveedores"]');
      checkboxes.forEach(cb => cb.checked = true);
      updateSelectedCount();
    }

    function deselectAll() {
      const checkboxes = document.querySelectorAll('input[name="proveedores"]');
      checkboxes.forEach(cb => cb.checked = false);
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const checkboxes = document.querySelectorAll('input[name="proveedores"]:checked');
      const countEl = document.getElementById('selectedCount');
      if (countEl) {
        countEl.textContent = checkboxes.length;
      }
    }

    // Actualizar contador al cargar
    document.addEventListener('DOMContentLoaded', function() {
      updateSelectedCount();
      
      // Validar que al menos un proveedor est√© seleccionado antes de enviar
      const form = document.getElementById('proveedoresForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          const checked = document.querySelectorAll('input[name="proveedores"]:checked');
          if (checked.length === 0) {
            e.preventDefault();
            alert('Por favor, selecciona al menos un proveedor para cargar.');
            return false;
          }
        });
      }
    });
  </script>
{% endblock %}


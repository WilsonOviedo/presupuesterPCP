{% extends 'base.html' %}
{% block title %}{% if item %}Editar{% else %}Nuevo{% endif %} Servicio{% endblock %}
{% block content %}
  <div class="actions" style="margin-bottom:10px;">
    <a class="button button-secondary" href="{{ url_for('items_index') }}">← Volver</a>
  </div>
  <h2>{% if item %}Editar{% else %}Nuevo{% endif %} Servicio</h2>

  <form id="servicio-form" method="post" action="{% if item %}{{ url_for('items_editar', id=item.id) }}{% else %}{{ url_for('items_nuevo') }}{% endif %}" style="max-width:600px;">
    <div style="display:grid; gap:15px;">
      <div>
        <label style="display:block; margin-bottom:5px; font-weight:600;">Código:</label>
        <div style="display:flex; gap:8px;">
          <input type="text" name="codigo" value="{{ item.codigo if item else '' }}" 
                 style="flex:1; padding:8px;" placeholder="Opcional">
          <button type="button" class="button button-secondary" id="btn-generar-codigo" style="padding:8px 12px;">Auto</button>
        </div>
        <small style="color:#555;">Genera un código basado en el tipo, descripción y la fecha actual.</small>
      </div>

      <div>
        <label style="display:block; margin-bottom:5px; font-weight:600;">Descripción: *</label>
        <input type="text" name="descripcion" value="{{ item.descripcion if item else '' }}" 
               required style="width:100%; padding:8px;" placeholder="Ej: Montaje de tablero eléctrico">
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <label style="display:block; margin-bottom:5px; font-weight:600;">Tipo: *</label>
          <select name="tipo" required style="width:100%; padding:8px; height:38px;">
            {% if tipos %}
              {% for tipo in tipos %}
                <option value="{{ tipo }}" {% if item and item.tipo == tipo %}selected{% endif %}>{{ tipo }}</option>
              {% endfor %}
            {% else %}
              <option value="Montaje" {% if item and item.tipo == 'Montaje' %}selected{% endif %}>Montaje</option>
              <option value="Programación" {% if item and item.tipo == 'Programación' %}selected{% endif %}>Programación</option>
              <option value="Materiales" {% if item and item.tipo == 'Materiales' %}selected{% endif %}>Materiales</option>
              <option value="Diseño" {% if item and item.tipo == 'Diseño' %}selected{% endif %}>Diseño</option>
              <option value="Otros" {% if not item or item.tipo == 'Otros' %}selected{% endif %}>Otros</option>
            {% endif %}
          </select>
        </div>

        <div>
          <label style="display:block; margin-bottom:5px; font-weight:600;">Unidad:</label>
          <input type="text" name="unidad" value="{{ item.unidad if item else 'unidad' }}" 
                 style="width:100%; padding:8px;" placeholder="unidad, hora, metro, kg">
        </div>
      </div>

      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div>
          <label style="display:block; margin-bottom:5px; font-weight:600;">Precio Base: *</label>
          <input type="number" name="precio_base" step="0.01" min="0" 
                 value="{{ item.precio_base if item else '0' }}" 
                 required style="width:100%; padding:8px;">
        </div>

        <div>
          <label style="display:block; margin-bottom:5px; font-weight:600;">Margen (%):</label>
          <input type="number" name="margen_porcentaje" step="0.01" min="0" 
                 value="{{ item.margen_porcentaje if item else '0' }}" 
                 style="width:100%; padding:8px;">
        </div>
      </div>

      <div>
        <label style="display:block; margin-bottom:5px; font-weight:600;">Precio con margen:</label>
        <input type="text" id="precio-final" value="{{ (item.precio_venta if item else 0)|gs_currency }}" readonly
               style="width:100%; padding:8px; background:#f5f5f5; border:1px solid #ccc;">
        <small style="color:#555;">Se calcula como <code>precio_base × 100 ÷ (100 − margen)</code>.</small>
      </div>

      <div>
        <label style="display:block; margin-bottom:5px; font-weight:600;">Notas:</label>
        <textarea name="notas" rows="3" style="width:100%; padding:8px;">{{ item.notas if item else '' }}</textarea>
      </div>

      {% if item %}
      <div>
        <label style="display:flex; align-items:center; gap:8px; margin-bottom:5px;">
          <input type="checkbox" name="activo" {% if item.activo %}checked{% endif %} style="width:auto;">
          <span style="font-weight:600;">Item activo</span>
        </label>
        <small style="color:#666;">Los items inactivos no aparecerán en las listas al crear presupuestos.</small>
      </div>
      {% endif %}

      <div class="actions">
        <button type="submit" class="button">{% if item %}Actualizar{% else %}Crear{% endif %}</button>
        <a href="{{ url_for('items_index') }}" class="button button-secondary">Cancelar</a>
      </div>
    </div>
  </form>
{% endblock %}

{% block scripts %}
  <script>
    (function() {
      const form = document.getElementById('servicio-form');
      if (!form) return;
      const precioInput = form.querySelector('input[name="precio_base"]');
      const margenInput = form.querySelector('input[name="margen_porcentaje"]');
      const salida = document.getElementById('precio-final');
      const codigoInput = form.querySelector('input[name="codigo"]');
      const tipoSelect = form.querySelector('select[name="tipo"]');
      const descripcionInput = form.querySelector('input[name="descripcion"]');
      const btnGenerarCodigo = document.getElementById('btn-generar-codigo');
      const formato = new Intl.NumberFormat('es-PY', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

      function toFloat(valor) {
        const numero = parseFloat(valor);
        return isNaN(numero) ? 0 : numero;
      }

      function recalcular() {
        if (!salida) return;
        const precio = toFloat(precioInput && precioInput.value);
        const margen = toFloat(margenInput && margenInput.value);
        const denominador = 100 - margen;
        if (denominador <= 0) {
          salida.value = 'Margen debe ser < 100';
          return;
        }
        const resultado = precio * 100 / denominador;
        salida.value = `Gs. ${formato.format(resultado)}`;
      }

      if (precioInput) {
        precioInput.addEventListener('input', recalcular);
        precioInput.addEventListener('blur', recalcular);
      }
      if (margenInput) {
        margenInput.addEventListener('input', recalcular);
        margenInput.addEventListener('blur', recalcular);
      }
      recalcular();

      function slug(texto) {
        return (texto || '')
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^A-Z0-9]/gi, '')
          .toUpperCase();
      }

      function generarCodigo() {
        if (!codigoInput) return;
        const tipo = slug(tipoSelect && tipoSelect.value || 'SR');
        const tipoSlug = slug(tipoSelect && tipoSelect.value || 'SRV');
        const descSlug = slug(descripcionInput && descripcionInput.value || 'S');
        const bloqueTipo = tipoSlug.slice(0, 3) || 'SRV';
        const letraDesc = descSlug.slice(0, 1) || 'S';
        const sufijo = String(Math.floor(100 + Math.random() * 900)).padStart(3, '0');
        codigoInput.value = `${bloqueTipo}-${letraDesc}-${sufijo}`;
      }

      if (btnGenerarCodigo) {
        btnGenerarCodigo.addEventListener('click', generarCodigo);
      }
    })();
  </script>
{% endblock %}


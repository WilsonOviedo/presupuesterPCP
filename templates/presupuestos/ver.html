{% extends 'base.html' %}
{% block title %}Presupuesto {{ presupuesto.numero_presupuesto }}{% endblock %}
{% block content %}
  <div class="actions" style="margin-bottom:10px;">
    <a class="button button-secondary" href="{{ url_for('presupuestos_index') }}">← Volver</a>
    <a class="button" href="{{ url_for('presupuestos_editar', id=presupuesto.id) }}">Editar</a>
    <a class="button button-secondary" href="{{ url_for('presupuestos_pdf', id=presupuesto.id) }}" target="_blank">Ver PDF</a>
  </div>
  <h2>Presupuesto: {{ presupuesto.numero_presupuesto }}</h2>

  <div id="async-feedback" style="display:none; margin:10px 0; padding:10px 14px; border-radius:6px;"></div>

  <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-bottom:20px;">
    <div>
      <h3>Información</h3>
      <table style="width:100%;">
        <tr><td style="font-weight:600; width:150px;">Título:</td><td>{{ presupuesto.titulo or '-' }}</td></tr>
        <tr><td style="font-weight:600;">Cliente:</td><td>{{ presupuesto.nombre_cliente }}</td></tr>
        <tr><td style="font-weight:600;">Fecha:</td><td>{{ presupuesto.fecha_presupuesto.strftime('%d/%m/%Y') if presupuesto.fecha_presupuesto else '-' }}</td></tr>
        <tr><td style="font-weight:600;">Validez:</td><td>{{ presupuesto.validez_dias }} días</td></tr>
        <tr><td style="font-weight:600;">Estado:</td><td>
          <span style="padding:4px 8px; border-radius:4px; font-size:0.9em; 
            {% if presupuesto.estado == 'aprobado' %}background:#d4edda; color:#155724;
            {% elif presupuesto.estado == 'enviado' %}background:#d1ecf1; color:#0c5460;
            {% elif presupuesto.estado == 'rechazado' %}background:#f8d7da; color:#721c24;
            {% elif presupuesto.estado == 'facturado' %}background:#d1ecf1; color:#0c5460;
            {% else %}background:#fff3cd; color:#856404;{% endif %}">
            {{ presupuesto.estado|upper }}
          </span>
        </td></tr>
        {% if presupuesto.descripcion %}
        <tr><td style="font-weight:600; vertical-align:top;">Descripción:</td><td>{{ presupuesto.descripcion }}</td></tr>
        {% endif %}
        {% if presupuesto.notas %}
        <tr><td style="font-weight:600; vertical-align:top;">Notas:</td><td>{{ presupuesto.notas }}</td></tr>
        {% endif %}
      </table>
    </div>

    <div style="background:#f7f7f7; padding:15px; border-radius:6px;">
      <h3>Totales</h3>
      <table style="width:100%;">
        <tr><td style="font-weight:600;">Items:</td><td style="text-align:right;" id="resumen-items">{{ presupuesto.cantidad_items }}</td></tr>
        <tr><td style="font-weight:600;">Subtotal:</td><td style="text-align:right;" id="resumen-subtotal">{{ presupuesto.subtotal|gs_currency }}</td></tr>
        <tr><td style="font-weight:600;">IVA ({{ presupuesto.iva_porcentaje }}%):</td><td style="text-align:right;" id="resumen-iva">{{ presupuesto.iva_monto|gs_currency }}</td></tr>
        <tr style="border-top:2px solid #333; font-size:1.2em;"><td style="font-weight:bold;">TOTAL:</td><td style="text-align:right; font-weight:bold;" id="resumen-total">{{ presupuesto.total|gs_currency }}</td></tr>
        {% if presupuesto.tiempo_ejecucion_total %}
        <tr style="border-top:1px solid #ddd; margin-top:10px;"><td style="font-weight:600;">Tiempo total:</td><td style="text-align:right;" id="resumen-tiempo">{{ presupuesto.tiempo_ejecucion_total|numero_local(2) }} horas</td></tr>
        {% endif %}
      </table>
    </div>
  </div>

  <h3>Subgrupos e Items</h3>
  <datalist id="datalist-servicios">
    {% for item in items_servicio %}
      <option value="{{ item.descripcion }}" data-id="{{ item.id }}" data-precio="{{ item.precio_venta or 0 }}" data-tiempo="{{ item.tiempo_instalacion or 0 }}" data-unidad="{{ item.unidad or 'UND' }}"></option>
    {% endfor %}
  </datalist>
  <datalist id="datalist-materiales">
    {% for item in items_materiales %}
      <option value="{{ item.descripcion }}" data-id="{{ item.id }}" data-precio="{{ item.precio_venta or 0 }}" data-tiempo="{{ item.tiempo_instalacion or 0 }}" data-unidad="{{ item.unidad or 'UND' }}"></option>
    {% endfor %}
  </datalist>
  <div style="background:#f7f7f7; padding:15px; border-radius:6px; margin-bottom:15px;">
    <h3 style="margin-top:0;">Agregar Subgrupo</h3>
    <form method="post" action="{{ url_for('presupuestos_agregar_subgrupo', id=presupuesto.id) }}" style="display:flex; gap:10px; align-items:end;">
      <div style="flex:1;">
        <label style="display:block; margin-bottom:5px; font-weight:600;">Número:</label>
        <input type="number" name="numero" value="{{ presupuesto.get('subgrupos', [])|length + 1 }}" min="1" 
               style="width:100%; padding:6px;">
      </div>
      <div style="flex:3;">
        <label style="display:block; margin-bottom:5px; font-weight:600;">Nombre del subgrupo:</label>
        <input type="text" name="nombre" required placeholder="Ej: MONTAJE DE BANDEJADO" 
               style="width:100%; padding:6px;">
      </div>
      <div>
        <button type="submit" class="button">Agregar Subgrupo</button>
      </div>
    </form>
  </div>
  
  {% if presupuesto.get('subgrupos') %}
    {% for subgrupo in presupuesto.get('subgrupos', []) %}
      <div style="background:#e8f4f8; padding:15px; border-radius:6px; margin-bottom:15px; border-left:4px solid #1976d2;" data-subgrupo-id="{{ subgrupo.id }}">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div>
            <h4 style="margin:0;">
              {{ subgrupo.numero }} - {{ subgrupo.nombre }}
              <form method="post" action="{{ url_for('presupuestos_actualizar_subgrupo', subgrupo_id=subgrupo.id) }}" style="display:inline-block; margin-left:10px;">
                <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                <input type="number" name="numero" value="{{ subgrupo.numero }}" min="1" style="width:50px; padding:2px;" onchange="this.form.submit()">
                <input type="text" name="nombre" value="{{ subgrupo.nombre }}" style="width:300px; padding:4px; margin-left:5px;" onchange="this.form.submit()">
              </form>
            </h4>
          </div>
          <div style="text-align:right;">
            <strong>Subtotal: <span class="js-subgrupo-subtotal" data-subgrupo-id="{{ subgrupo.id }}">{{ subgrupo.subtotal|gs_currency }}</span></strong><br>
            <small>Tiempo: <span class="js-subgrupo-tiempo" data-subgrupo-id="{{ subgrupo.id }}">{{ subgrupo.tiempo_ejecucion_horas|numero_local(2) }}</span> horas</small>
            <form method="post" action="{{ url_for('presupuestos_eliminar_subgrupo', subgrupo_id=subgrupo.id) }}" style="display:inline; margin-left:10px;">
              <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
              <button type="submit" onclick="return confirm('¿Eliminar este subgrupo? Los items quedarán sin subgrupo.')" 
                      style="padding:4px 8px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.85em;">Eliminar</button>
            </form>
          </div>
        </div>
        
        {% if subgrupo.get('items') %}
          <table style="width:100%; background:white; border-radius:4px;">
            <tr style="background:#f0f0f0;">
              <th style="width:60px;">Nº</th>
              <th style="width:45%; text-align:left;">Descripción</th>
              <th style="width:140px;">Proveedor</th>
              <th style="width:80px;">Cant.</th>
              <th style="width:90px;">Unidad</th>
              <th style="width:100px;">Precio Unit.</th>
              <th style="width:100px;">Subtotal</th>
              <th style="width:80px;">Tiempo (h)</th>
              <th style="width:100px;">Acciones</th>
            </tr>
            {% for item in subgrupo.get('items', []) %}
              <tr data-item-id="{{ item.id }}" data-subgrupo-id="{{ subgrupo.id }}">
                <td style="text-align:center;">
                  <form method="post" action="{{ url_for('presupuestos_actualizar_item', item_id=item.id) }}" style="display:inline;" data-async="item-update" data-item-id="{{ item.id }}">
                    <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                    <input type="hidden" name="subgrupo_id" value="{{ subgrupo.id }}">
                    <input type="hidden" name="material_id" value="{{ item.material_id or '' }}">
                    <input type="text" name="numero_subitem" value="{{ item.numero_subitem or '' }}" 
                           style="width:50px; padding:2px; text-align:center;" 
                           placeholder="{{ subgrupo.numero }}.{{ loop.index }}">
                  </form>
                </td>
                <td style="text-align:left;">
                  <form method="post" action="{{ url_for('presupuestos_actualizar_item', item_id=item.id) }}" style="display:inline;" data-async="item-update" data-item-id="{{ item.id }}">
                    <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                    <input type="hidden" name="subgrupo_id" value="{{ subgrupo.id }}">
                    <input type="hidden" name="material_id" value="{{ item.material_id or '' }}">
                    <input type="text" name="descripcion" value="{{ item.descripcion }}" 
                           style="width:100%; padding:4px; text-align:left;">
                  </form>
                </td>
                <td style="text-align:left; white-space:nowrap; font-size:0.85em;">{{ item.proveedor or '-' }}</td>
                <td style="text-align:right;">
                  <form method="post" action="{{ url_for('presupuestos_actualizar_item', item_id=item.id) }}" style="display:inline;" data-async="item-update" data-item-id="{{ item.id }}">
                    <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                    <input type="hidden" name="subgrupo_id" value="{{ subgrupo.id }}">
                    <input type="hidden" name="material_id" value="{{ item.material_id or '' }}">
                    <input type="number" name="cantidad" step="0.01" value="{{ item.cantidad }}" 
                           style="width:70px; padding:4px; text-align:right;">
                  </form>
                </td>
                <td style="text-align:center;">
                  <form method="post" action="{{ url_for('presupuestos_actualizar_item', item_id=item.id) }}" style="display:inline;" data-async="item-update" data-item-id="{{ item.id }}">
                    <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                    <input type="hidden" name="subgrupo_id" value="{{ subgrupo.id }}">
                    <input type="hidden" name="material_id" value="{{ item.material_id or '' }}">
                    <input type="text" name="unidad" value="{{ item.unidad or '' }}" 
                           style="width:80px; padding:4px; text-align:center;" maxlength="25">
                  </form>
                </td>
                <td style="text-align:right;">
                  <form method="post" action="{{ url_for('presupuestos_actualizar_item', item_id=item.id) }}" style="display:inline;" data-async="item-update" data-item-id="{{ item.id }}">
                    <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                    <input type="hidden" name="subgrupo_id" value="{{ subgrupo.id }}">
                    <input type="hidden" name="material_id" value="{{ item.material_id or '' }}">
                    <input type="number" name="precio_unitario" step="0.01" value="{{ item.precio_unitario }}" 
                           style="width:90px; padding:4px; text-align:right;">
                  </form>
                </td>
                <td style="text-align:right;"><strong class="js-item-subtotal" data-item-id="{{ item.id }}">{{ item.subtotal|gs_currency }}</strong></td>
                <td style="text-align:right;">
                  <form method="post" action="{{ url_for('presupuestos_actualizar_item', item_id=item.id) }}" style="display:inline;" data-async="item-update" data-item-id="{{ item.id }}">
                    <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                    <input type="hidden" name="subgrupo_id" value="{{ subgrupo.id }}">
                    <input type="hidden" name="material_id" value="{{ item.material_id or '' }}">
                    <input type="number" name="tiempo_ejecucion_horas" step="0.01" value="{{ item.tiempo_ejecucion_horas or 0 }}" 
                           style="width:70px; padding:4px; text-align:right;">
                  </form>
                </td>
                <td>
                  <form method="post" action="{{ url_for('presupuestos_eliminar_item', item_id=item.id) }}" style="display:inline;" data-async="item-delete" data-item-id="{{ item.id }}" data-subgrupo-id="{{ subgrupo.id }}">
                    <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                    <input type="hidden" name="subgrupo_id" value="{{ subgrupo.id }}">
                    <button type="submit" 
                            style="padding:4px 8px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.85em;">Eliminar</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </table>
          <div class="js-no-items" style="display:none; color:#666; font-style:italic; margin-top:6px;">No hay items en este subgrupo.</div>
        {% else %}
          <p style="color:#666; font-style:italic;">No hay items en este subgrupo.</p>
        {% endif %}

        <div class="subgrupo-add-item" style="margin-top:12px;">
          <button type="button" class="button button-secondary btn-toggle-item" data-target="form-subgrupo-{{ subgrupo.id }}">+ Agregar item</button>
          <form id="form-subgrupo-{{ subgrupo.id }}" method="post" action="{{ url_for('presupuestos_agregar_item', id=presupuesto.id) }}" style="display:none; margin-top:10px; background:#ffffff; padding:12px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.08);">
            <input type="hidden" name="subgrupo_id" value="{{ subgrupo.id }}">
            <input type="hidden" name="orden" value="{{ (subgrupo.get('items') or [])|length + 1 }}">
            <input type="hidden" name="item_id" class="hidden-item-id" value="">
            <input type="hidden" name="material_id" class="hidden-material-id" value="">
            <div style="display:grid; grid-template-columns: 1.2fr 2fr 1fr 0.9fr 1fr 1fr 1fr auto; gap:10px; align-items:end;">
              <div>
                <label style="display:block; margin-bottom:5px; font-weight:600;">Tipo de item:</label>
                <select class="item-source" style="width:100%; padding:6px; height:34px;">
                  <option value="material" {% if not items_materiales %}disabled{% else %}selected{% endif %}>Materiales eléctricos</option>
                  <option value="servicio" {% if not items_servicio %}disabled{% endif %} {% if not items_materiales and items_servicio %}selected{% endif %}>Mano de obra / servicios</option>
                </select>
              </div>
              <div>
                <label style="display:block; margin-bottom:5px; font-weight:600;">Item:</label>
                <div class="item-select-wrapper">
                  <input type="text" class="item-input item-input-servicio" list="datalist-servicios" placeholder="Buscar servicio" style="width:260px; max-width:100%; padding:6px 8px; height:34px; {% if not items_servicio %}display:none;{% endif %}">
                  <input type="text" class="item-input item-input-material" list="datalist-materiales" placeholder="Buscar material" {% if items_materiales %}style="width:260px; max-width:100%; padding:6px 8px; height:34px; display:block;"{% else %}style="width:260px; max-width:100%; padding:6px 8px; height:34px; display:none;" disabled{% endif %}>
                </div>
              </div>
              <div>
                <label style="display:block; margin-bottom:5px; font-weight:600;">Nº Subitem:</label>
                <input type="text" name="numero_subitem" style="width:100%; padding:6px;" placeholder="{{ subgrupo.numero }}.{{ (subgrupo.get('items') or [])|length + 1 }}">
              </div>
              <div>
                <label style="display:block; margin-bottom:5px; font-weight:600;">Cantidad:</label>
                <input type="number" name="cantidad" step="0.01" value="1" min="0.01" required style="width:100%; padding:6px;">
              </div>
              <div>
                <label style="display:block; margin-bottom:5px; font-weight:600;">Unidad:</label>
                <input type="text" name="unidad" value="UND" data-default="UND" style="width:100%; padding:6px;" maxlength="25">
              </div>
              <div>
                <label style="display:block; margin-bottom:5px; font-weight:600;">Precio Unit.:</label>
                <input type="number" name="precio_unitario" step="0.01" min="0" class="precio-unitario-input" style="width:100%; padding:6px;">
              </div>
              <div>
                <label style="display:block; margin-bottom:5px; font-weight:600;">Tiempo (h):</label>
                <input type="number" name="tiempo_ejecucion_horas" step="0.01" min="0" value="0" style="width:100%; padding:6px;">
              </div>
              <div>
                <button type="submit" class="button">Agregar</button>
              </div>
            </div>
            <div style="margin-top:8px;">
              <label style="display:block; margin-bottom:5px; font-weight:600;">Notas:</label>
              <input type="text" name="notas" style="width:100%; padding:6px;" placeholder="Notas opcionales del item">
            </div>
          </form>
        </div>
      </div>
    {% endfor %}
  {% endif %}

  {% if presupuesto.get('items_sin_subgrupo') %}
    <div style="background:#fff3cd; padding:15px; border-radius:6px; margin-bottom:15px;">
      <h4>Items sin subgrupo</h4>
      <table style="width:100%;">
        <tr>
          <th style="width:45%; text-align:left;">Descripción</th>
          <th style="width:140px;">Proveedor</th>
          <th>Cantidad</th>
          <th>Unidad</th>
          <th>Precio Unit.</th>
          <th>Subtotal</th>
          <th>Tiempo (h)</th>
          <th>Acciones</th>
        </tr>
        {% for item in presupuesto.get('items_sin_subgrupo', []) %}
          <tr data-item-id="{{ item.id }}" data-subgrupo-id="">
            <td style="text-align:left;">{{ item.descripcion }}</td>
            <td style="text-align:left; white-space:nowrap; font-size:0.85em;">{{ item.proveedor or '-' }}</td>
            <td style="text-align:right;">{{ item.cantidad|numero_local(2) }}</td>
            <td style="text-align:center;">{{ item.unidad or 'UND' }}</td>
            <td style="text-align:right;">{{ item.precio_unitario|gs_currency }}</td>
            <td style="text-align:right;"><strong class="js-item-subtotal" data-item-id="{{ item.id }}">{{ item.subtotal|gs_currency }}</strong></td>
            <td style="text-align:right;">{{ item.tiempo_ejecucion_horas|numero_local(2) }}</td>
            <td>
              <form method="post" action="{{ url_for('presupuestos_eliminar_item', item_id=item.id) }}" style="display:inline;" data-async="item-delete" data-item-id="{{ item.id }}" data-subgrupo-id="">
                <input type="hidden" name="presupuesto_id" value="{{ presupuesto.id }}">
                <input type="hidden" name="subgrupo_id" value="">
                <button type="submit" 
                        style="padding:4px 8px; background:#dc3545; color:white; border:none; border-radius:4px; cursor:pointer; font-size:0.85em;">Eliminar</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </table>
      <div class="js-no-items" style="display:none; color:#666; font-style:italic; margin-top:6px;">No hay items sin subgrupo.</div>
    </div>
  {% endif %}

{% endblock %}

{% block scripts %}
  <script>
    document.querySelectorAll('.btn-toggle-item').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const targetId = btn.getAttribute('data-target');
        const target = document.getElementById(targetId);
        if (!target) return;
        if (target.style.display === 'none' || target.style.display === '') {
          target.style.display = 'block';
        } else {
          target.style.display = 'none';
        }
      });
    });

    document.querySelectorAll('.subgrupo-add-item form').forEach(function(form) {
      const sourceSelect = form.querySelector('.item-source');
      const servicioInput = form.querySelector('.item-input-servicio');
      const materialInput = form.querySelector('.item-input-material');
      const hiddenItem = form.querySelector('.hidden-item-id');
      const hiddenMaterial = form.querySelector('.hidden-material-id');
      const precioInput = form.querySelector('.precio-unitario-input');
      const tiempoInput = form.querySelector('input[name="tiempo_ejecucion_horas"]');
      const unidadInput = form.querySelector('input[name="unidad"]');

      function tieneOpciones(input) {
        if (!input) return false;
        const listId = input.getAttribute('list');
        if (!listId) return false;
        const datalist = document.getElementById(listId);
        if (!datalist) return false;
        return Array.from(datalist.options).some(function(opt) {
          return opt.getAttribute('data-id');
        });
      }

      function encontrarOpcion(input) {
        if (!input) return null;
        const listId = input.getAttribute('list');
        if (!listId) return null;
        const datalist = document.getElementById(listId);
        if (!datalist) return null;
        return Array.from(datalist.options).find(function(opt) {
          return opt.value === input.value;
        }) || null;
      }

      function actualizarDesdeInput(input, hiddenField) {
        if (!input || !hiddenField) return;
        const opcion = encontrarOpcion(input);
        if (opcion) {
          hiddenField.value = opcion.getAttribute('data-id') || '';
          if (precioInput) {
            const precio = opcion.getAttribute('data-precio');
            if (precio !== null && precio !== '') {
              precioInput.value = precio;
            }
          }
          if (tiempoInput) {
            const tiempo = opcion.getAttribute('data-tiempo');
            if (tiempo !== null && tiempo !== '') {
              tiempoInput.value = tiempo;
            }
          }
          if (unidadInput) {
            const unidad = opcion.getAttribute('data-unidad');
            if (unidad !== null && unidad !== '') {
              unidadInput.value = unidad;
            }
          }
        } else {
          hiddenField.value = '';
        }
      }

      function setActivo(tipoDeseado) {
        const servicioValido = tieneOpciones(servicioInput);
        const materialValido = tieneOpciones(materialInput);
        let tipoActual = tipoDeseado;

        if (tipoActual === 'material' && !materialValido && servicioValido) {
          tipoActual = 'servicio';
        } else if (tipoActual !== 'material' && !servicioValido && materialValido) {
          tipoActual = 'material';
        } else if (!servicioValido && !materialValido) {
          tipoActual = null;
        }

        if (tipoActual === 'material') {
          if (servicioInput) {
            servicioInput.style.display = 'none';
            servicioInput.disabled = true;
            servicioInput.required = false;
            servicioInput.value = '';
          }
          if (hiddenItem) hiddenItem.value = '';
          if (materialInput) {
            materialInput.style.display = 'block';
            materialInput.disabled = false;
            materialInput.required = true;
          }
          if (hiddenMaterial) hiddenMaterial.value = '';
          form.dataset.activo = 'material';
          if (sourceSelect) sourceSelect.value = 'material';
          actualizarDesdeInput(materialInput, hiddenMaterial);
          if (!hiddenMaterial.value && unidadInput) {
            unidadInput.value = unidadInput.getAttribute('data-default') || 'UND';
          }
        } else if (tipoActual === 'servicio') {
          if (materialInput) {
            materialInput.style.display = 'none';
            materialInput.disabled = true;
            materialInput.required = false;
            materialInput.value = '';
          }
          if (hiddenMaterial) hiddenMaterial.value = '';
          if (servicioInput) {
            servicioInput.style.display = 'block';
            servicioInput.disabled = false;
            servicioInput.required = true;
          }
          if (hiddenItem) hiddenItem.value = '';
          form.dataset.activo = 'servicio';
          if (sourceSelect) sourceSelect.value = 'servicio';
          actualizarDesdeInput(servicioInput, hiddenItem);
          if (!hiddenItem.value && unidadInput) {
            unidadInput.value = unidadInput.getAttribute('data-default') || 'UND';
          }
        } else {
          form.dataset.activo = '';
          if (servicioInput) {
            servicioInput.style.display = 'none';
            servicioInput.disabled = true;
            servicioInput.required = false;
            servicioInput.value = '';
          }
          if (materialInput) {
            materialInput.style.display = 'none';
            materialInput.disabled = true;
            materialInput.required = false;
            materialInput.value = '';
          }
          if (hiddenItem) hiddenItem.value = '';
          if (hiddenMaterial) hiddenMaterial.value = '';
          if (unidadInput) {
            unidadInput.value = unidadInput.getAttribute('data-default') || 'UND';
          }
        }
      }

      if (sourceSelect) {
        sourceSelect.addEventListener('change', function() {
          setActivo(this.value);
        });
      }

      if (servicioInput && hiddenItem) {
        servicioInput.addEventListener('input', function() {
          actualizarDesdeInput(servicioInput, hiddenItem);
        });
        servicioInput.addEventListener('change', function() {
          actualizarDesdeInput(servicioInput, hiddenItem);
        });
      }

      if (materialInput && hiddenMaterial) {
        materialInput.addEventListener('input', function() {
          actualizarDesdeInput(materialInput, hiddenMaterial);
        });
        materialInput.addEventListener('change', function() {
          actualizarDesdeInput(materialInput, hiddenMaterial);
        });
      }

      const tipoInicial = sourceSelect && sourceSelect.value
        ? sourceSelect.value
        : (tieneOpciones(servicioInput) ? 'servicio' : 'material');
      setActivo(tipoInicial);
    });
  </script>
  <script>
    (function() {
      const formatterGs = new Intl.NumberFormat('es-PY', { minimumFractionDigits: 0 });
      const formatterNum2 = new Intl.NumberFormat('es-PY', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

      const feedbackBox = document.getElementById('async-feedback');
      let changeListenerBound = false;
      let deleteListenerBound = false;

      function formatGs(valor) {
        return `Gs. ${formatterGs.format(Math.round((valor ?? 0)))}`;
      }

      function formatNumber(valor, decimals = 2) {
        if (valor === null || valor === undefined || Number.isNaN(valor)) {
          return decimals === 0 ? '0' : formatterNum2.format(0);
        }
        if (decimals === 0) {
          return formatterGs.format(Math.round(valor));
        }
        return formatterNum2.format(valor);
      }

      function toInputValue(valor, decimals = 2) {
        if (valor === null || valor === undefined || Number.isNaN(valor)) {
          return '';
        }
        return Number(valor).toFixed(decimals);
      }

      function setFeedback(mensaje, tipo = 'success') {
        if (!feedbackBox) return;
        feedbackBox.textContent = mensaje;
        feedbackBox.style.display = 'block';
        feedbackBox.style.background = tipo === 'error' ? '#fdecea' : '#e8f5e9';
        feedbackBox.style.color = tipo === 'error' ? '#b71c1c' : '#256029';
        if (feedbackBox.dataset.timeoutId) {
          clearTimeout(Number(feedbackBox.dataset.timeoutId));
        }
        feedbackBox.dataset.timeoutId = String(setTimeout(function() {
          feedbackBox.style.display = 'none';
        }, 2500));
      }

      function updateTotals(totales) {
        if (!totales) return;
        const subtotalEl = document.getElementById('resumen-subtotal');
        if (subtotalEl) subtotalEl.textContent = formatGs(totales.subtotal || 0);
        const ivaEl = document.getElementById('resumen-iva');
        if (ivaEl) ivaEl.textContent = formatGs(totales.iva_monto || 0);
        const totalEl = document.getElementById('resumen-total');
        if (totalEl) totalEl.textContent = formatGs(totales.total || 0);
        const itemsEl = document.getElementById('resumen-items');
        if (itemsEl && totales.cantidad_items !== undefined) itemsEl.textContent = totales.cantidad_items;
        const tiempoEl = document.getElementById('resumen-tiempo');
        if (tiempoEl && totales.tiempo_total !== undefined && totales.tiempo_total !== null) {
          tiempoEl.textContent = `${formatNumber(totales.tiempo_total || 0)} horas`;
        }
      }

      function updateSubgrupo(subgrupo) {
        if (!subgrupo || subgrupo.id === null || subgrupo.id === undefined) return;
        const subtotalEl = document.querySelector(`.js-subgrupo-subtotal[data-subgrupo-id="${subgrupo.id}"]`);
        if (subtotalEl) subtotalEl.textContent = formatGs(subgrupo.subtotal || 0);
        const tiempoEl = document.querySelector(`.js-subgrupo-tiempo[data-subgrupo-id="${subgrupo.id}"]`);
        if (tiempoEl) tiempoEl.textContent = formatNumber(subgrupo.tiempo_ejecucion_horas || 0);
      }

      function highlightRow(row) {
        if (!row) return;
        const original = row.dataset.originalColor || row.style.backgroundColor || '';
        row.dataset.originalColor = original;
        row.style.transition = 'background-color 0.4s ease';
        row.style.backgroundColor = '#e0f7fa';
        setTimeout(function() {
          row.style.backgroundColor = original;
        }, 600);
      }

      function removeItemRow(itemId) {
        const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
        if (!row) return;
        const table = row.closest('table');
        row.remove();
        if (table) {
          const remaining = table.querySelectorAll('tr[data-item-id]').length;
          if (remaining === 0) {
            const emptyNotice = table.parentElement && table.parentElement.querySelector('.js-no-items');
            if (emptyNotice) {
              emptyNotice.style.display = 'block';
            }
            table.style.display = 'none';
          } else {
            table.style.display = '';
            const emptyNotice = table.parentElement && table.parentElement.querySelector('.js-no-items');
            if (emptyNotice) {
              emptyNotice.style.display = 'none';
            }
          }
        }
      }

      function updateItemRow(item) {
        if (!item || item.id === undefined) return;
        const row = document.querySelector(`tr[data-item-id="${item.id}"]`);
        if (!row) return;
        row.setAttribute('data-subgrupo-id', item.subgrupo_id != null ? item.subgrupo_id : '');

        const subtotalEl = row.querySelector('.js-item-subtotal');
        if (subtotalEl) subtotalEl.textContent = formatGs(item.subtotal || 0);

        const pairs = [
          ['input[name="cantidad"]', item.cantidad, 2],
          ['input[name="precio_unitario"]', item.precio_unitario, 2],
          ['input[name="tiempo_ejecucion_horas"]', item.tiempo_ejecucion_horas, 2],
          ['input[name="numero_subitem"]', item.numero_subitem, null],
          ['input[name="descripcion"]', item.descripcion, null],
          ['input[name="unidad"]', item.unidad, null],
        ];
        pairs.forEach(function(pair) {
          const [selector, valor, decimals] = pair;
          const input = row.querySelector(selector);
          if (!input) return;
          if (decimals === null) {
            input.value = valor != null ? valor : '';
          } else {
            input.value = toInputValue(valor, decimals);
          }
        });

        highlightRow(row);
      }

      function submitAsyncForm(form) {
        if (!form || form.dataset.loading === '1') return;
        form.dataset.loading = '1';
        const formData = new FormData(form);
        fetch(form.action, {
          method: form.method || 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Error al guardar los cambios');
            }
            return response.json();
          })
          .then(function(data) {
            if (!data || data.ok === false) {
              throw new Error((data && data.error) || 'No se pudo actualizar');
            }
            if (data.item) {
              updateItemRow(data.item);
            }
            if (data.subgrupo) {
              updateSubgrupo(data.subgrupo);
            }
            if (data.totales) {
              updateTotals(data.totales);
            }
            setFeedback('Cambios guardados correctamente');
          })
          .catch(function(error) {
            console.error(error);
            setFeedback(error.message || 'Error al guardar', 'error');
          })
          .finally(function() {
            delete form.dataset.loading;
            delete form.dataset.confirmed;
          });
      }

      function submitDeleteForm(form) {
        if (!form || form.dataset.loading === '1') return;
        form.dataset.loading = '1';
        const formData = new FormData(form);
        fetch(form.action, {
          method: form.method || 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
        })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('Error al eliminar el item');
            }
            return response.json();
          })
          .then(function(data) {
            if (!data || data.ok === false) {
              throw new Error((data && data.error) || 'No se pudo eliminar');
            }
            if (data.item_id !== undefined) {
              removeItemRow(data.item_id);
            }
            if (data.subgrupo) {
              updateSubgrupo(data.subgrupo);
            }
            if (data.totales) {
              updateTotals(data.totales);
            }
            setFeedback('Item eliminado');
          })
          .catch(function(error) {
            console.error(error);
            setFeedback(error.message || 'Error al eliminar', 'error');
          })
          .finally(function() {
            delete form.dataset.loading;
          });
      }

      function bindAsyncForms() {
        document.querySelectorAll('form[data-async="item-update"]').forEach(function(form) {
          if (form.dataset.bound === '1') return;
          form.dataset.bound = '1';
          form.addEventListener('submit', function(event) {
            event.preventDefault();
            submitAsyncForm(form);
          });
        });
        if (!changeListenerBound) {
          document.addEventListener('change', function(event) {
            const target = event.target;
            if (!(target instanceof HTMLInputElement || target instanceof HTMLSelectElement || target instanceof HTMLTextAreaElement)) {
              return;
            }
            const form = target.closest('form[data-async="item-update"]');
            if (!form) return;
            submitAsyncForm(form);
          });
          changeListenerBound = true;
        }
        if (!deleteListenerBound) {
          document.addEventListener('submit', function(event) {
            const form = event.target;
            if (!(form instanceof HTMLFormElement)) return;
            if (form.dataset.async !== 'item-delete') return;
            event.preventDefault();
            if (form.dataset.confirmed !== 'true') {
              if (!window.confirm('¿Eliminar este item?')) {
                return;
              }
              form.dataset.confirmed = 'true';
            }
            submitDeleteForm(form);
          }, true);
          deleteListenerBound = true;
        }
      }

      bindAsyncForms();
    })();
  </script>
{% endblock %}

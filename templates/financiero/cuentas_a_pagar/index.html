{% extends 'base.html' %}
{% block title %}Cuentas a Pagar{% endblock %}
{% block head %}
  <style>
    body {
      margin: 0 !important;
      padding: 0 !important;
    }
    .container {
      max-width: 100% !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    .filtros-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .filtros-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }
    .form-group input,
    .form-group select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .cuentas-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .cuentas-table thead {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%) !important;
      color: white !important;
    }
    .cuentas-table thead th {
      background: transparent !important;
      color: white !important;
    }
    .cuentas-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .cuentas-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #e8e8e8;
      font-size: 0.85em;
    }
    .cuentas-table tbody tr {
      transition: background-color 0.2s ease;
    }
    .cuentas-table tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .cuentas-table tbody tr:hover {
      background: #ffebee;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
      display: inline-block;
    }
    .status-pagado {
      background: #d4edda;
      color: #155724;
    }
    .status-abierto {
      background: #fff3cd;
      color: #856404;
    }
    .status-adelantado {
      background: #d1ecf1;
      color: #0c5460;
    }
    .status-atrasado {
      background: #f8d7da;
      color: #721c24;
    }
    .status-en-dia {
      background: #d4edda;
      color: #155724;
    }
    .valor-negativo {
      color: #2e7d32 !important;
      font-weight: bold !important;
    }
    .paginacion {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      flex-wrap: wrap;
      gap: 10px;
    }
    .paginacion-info {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .paginacion-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .paginacion-controls select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .paginacion-buttons {
      display: flex;
      gap: 5px;
    }
    .paginacion-buttons a,
    .paginacion-buttons button {
      padding: 8px 12px;
      background: #f44336;
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.2s;
    }
    .paginacion-buttons a:hover,
    .paginacion-buttons button:hover {
      background: #d32f2f;
    }
    .paginacion-buttons a:disabled,
    .paginacion-buttons button:disabled {
      background: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }
  </style>
{% endblock %}
{% block content %}
  <div style="max-width: 100%; margin: 0; padding: 0;">
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <a class="button button-secondary" href="{{ url_for('financiero_index') }}">‚Üê Volver</a>
      </div>
      <div style="display: flex; gap: 10px;">
        <a class="button" href="{{ url_for('cuentas_a_pagar_exportar_csv', **request.args) }}" style="background: #4CAF50;">üì• Exportar CSV</a>
        <button type="button" class="button" onclick="document.getElementById('importarCsvInput').click()" style="background: #FF9800;">üì§ Importar CSV</button>
        <input type="file" id="importarCsvInput" accept=".csv" style="display: none;" onchange="importarCSV(this)">
        <a class="button" href="{{ url_for('cuenta_a_pagar_nuevo') }}" style="background: #f44336;">‚ûï Nueva Cuenta a Pagar</a>
      </div>
    </div>

    <h2>üí∏ Cuentas a Pagar</h2>

    {% if error %}
      <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ef5350;">
        <strong>Error:</strong> {{ error }}
      </div>
    {% endif %}

    {% if mensaje %}
      <div style="background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #4caf50;">
        <strong>√âxito:</strong> {{ mensaje }}
      </div>
    {% endif %}

    <div class="filtros-section">
      <h3 style="margin-top: 0;">Filtros</h3>
      <form method="GET" action="{{ url_for('cuentas_a_pagar_index') }}">
        <div class="filtros-row">
          <div class="form-group">
            <label for="fecha_desde">Fecha desde:</label>
            <input type="date" id="fecha_desde" name="fecha_desde" value="{{ fecha_desde }}">
          </div>
          <div class="form-group">
            <label for="fecha_hasta">Fecha hasta:</label>
            <input type="date" id="fecha_hasta" name="fecha_hasta" value="{{ fecha_hasta }}">
          </div>
          <div class="form-group">
            <label for="proveedor">Proveedor:</label>
            <input type="text" id="proveedor" name="proveedor" value="{{ proveedor_filtro }}" placeholder="Buscar proveedor...">
          </div>
          <div class="form-group">
            <label for="estado">Estado:</label>
            <select id="estado" name="estado">
              <option value="">Todos</option>
              <option value="PAGADO" {% if estado_filtro == 'PAGADO' %}selected{% endif %}>Pagado</option>
              <option value="ABIERTO" {% if estado_filtro == 'ABIERTO' %}selected{% endif %}>Abierto</option>
            </select>
          </div>
          <div class="form-group">
            <label for="banco_id">Banco:</label>
            <select id="banco_id" name="banco_id">
              <option value="">Todos</option>
              {% for banco in bancos %}
                <option value="{{ banco.id }}" {% if banco_filtro == banco.id %}selected{% endif %}>{{ banco.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="cuenta_id">Cuenta:</label>
            <select id="cuenta_id" name="cuenta_id">
              <option value="">Todas</option>
              {% for cuenta in categorias_gastos %}
                <option value="{{ cuenta.id }}" {% if cuenta_filtro == cuenta.id %}selected{% endif %}>{{ cuenta.nombre }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="saldo_filtro">Saldo:</label>
            <select id="saldo_filtro" name="saldo_filtro">
              <option value="" {% if not saldo_filtro %}selected{% endif %}>Todos</option>
              <option value=">0" {% if saldo_filtro == '>0' %}selected{% endif %}>Con saldo (>0)</option>
              <option value="=0" {% if saldo_filtro == '=0' %}selected{% endif %}>Sin saldo (=0)</option>
            </select>
          </div>
          <div class="form-group">
            <label for="fecha_pago_desde">Fecha Pago desde:</label>
            <input type="date" id="fecha_pago_desde" name="fecha_pago_desde" value="{{ fecha_pago_desde }}">
          </div>
          <div class="form-group">
            <label for="fecha_pago_hasta">Fecha Pago hasta:</label>
            <input type="date" id="fecha_pago_hasta" name="fecha_pago_hasta" value="{{ fecha_pago_hasta }}">
          </div>
          <div class="form-group">
            <label for="plano_cuenta">Plano de Cuenta:</label>
            <input type="text" id="plano_cuenta" name="plano_cuenta" value="{{ plano_cuenta_filtro }}" placeholder="Buscar plano de cuenta...">
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button type="submit" class="button" style="background: #f44336;">üîç Buscar</button>
          <a href="{{ url_for('cuentas_a_pagar_index') }}" class="button button-secondary">Limpiar filtros</a>
        </div>
      </form>
    </div>

    <div style="overflow-x: auto;">
      <table class="cuentas-table">
        <thead>
          <tr>
            <th>Fecha Emisi√≥n</th>
            <th>Medio de Pago</th>
            <th>Cuenta</th>
            <th>Plano de Cuenta</th>
            <th>Proyecto</th>
            <th>Tipo</th>
            <th>Proveedor</th>
            <th>Documento</th>
            <th>Descripci√≥n</th>
            <th>Banco</th>
            <th>Valor</th>
            <th>Cuotas</th>
            <th>Valor Cuota</th>
            <th>Monto Abonado</th>
            <th>Saldo</th>
            <th>Vencimiento</th>
            <th>Fecha Pago</th>
            <th>Estado</th>
            <th>Status Pago</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for cuenta in cuentas %}
            <tr>
              <td>{{ cuenta.fecha_emision.strftime('%d/%m/%Y') if cuenta.fecha_emision else '-' }}</td>
              <td>{{ cuenta.documento_nombre or '-' }}</td>
              <td>{{ cuenta.cuenta_nombre or '-' }}</td>
              <td>{{ cuenta.plano_cuenta or '-' }}</td>
              <td>{{ cuenta.proyecto_nombre or '-' }}</td>
              <td>{{ cuenta.tipo or '-' }}</td>
              <td>{{ cuenta.proveedor or '-' }}</td>
              <td>{{ cuenta.factura or '-' }}</td>
              <td>{{ cuenta.descripcion or '-' }}</td>
              <td>{{ cuenta.banco_nombre or '-' }}</td>
              <td style="text-align: right;" {% if cuenta.valor and cuenta.valor < 0 %}class="valor-negativo"{% endif %}>
                {% if cuenta.valor and cuenta.valor < 0 %}
                  ({{ "{:,.2f}".format(abs(cuenta.valor)) }})
                {% else %}
                  {{ "{:,.2f}".format(cuenta.valor) if cuenta.valor else '0.00' }}
                {% endif %}
              </td>
              <td>{{ cuenta.cuotas or '-' }}</td>
              <td style="text-align: right;" {% if cuenta.valor_cuota and cuenta.valor_cuota < 0 %}class="valor-negativo"{% endif %}>
                {% if cuenta.valor_cuota and cuenta.valor_cuota < 0 %}
                  ({{ "{:,.2f}".format(abs(cuenta.valor_cuota)) }})
                {% elif cuenta.valor_cuota %}
                  {{ "{:,.2f}".format(cuenta.valor_cuota) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td style="text-align: right;">
                {{ "{:,.2f}".format(cuenta.monto_abonado or 0) }}
              </td>
              <td style="text-align: right;" {% if cuenta.saldo and cuenta.saldo < 0 %}class="valor-negativo"{% endif %}>
                {% if cuenta.saldo and cuenta.saldo < 0 %}
                  ({{ "{:,.2f}".format(abs(cuenta.saldo)) }})
                {% else %}
                  {{ "{:,.2f}".format(cuenta.saldo or 0) }}
                {% endif %}
              </td>
              <td>{{ cuenta.vencimiento.strftime('%d/%m/%Y') if cuenta.vencimiento else '-' }}</td>
              <td>{{ cuenta.fecha_pago.strftime('%d/%m/%Y') if cuenta.fecha_pago else '-' }}</td>
              <td>
                <span class="status-badge status-{{ cuenta.estado.lower().replace(' ', '-') }}">
                  {{ cuenta.estado or '-' }}
                </span>
              </td>
              <td>
                {% if cuenta.status_pago %}
                  <span class="status-badge status-{{ cuenta.status_pago.lower().replace(' ', '-') }}">
                    {{ cuenta.status_pago }}
                  </span>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                  <a href="{{ url_for('cuenta_a_pagar_editar', id=cuenta.id) }}" 
                     style="padding: 4px 8px; background: #f44336; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8em;">‚úèÔ∏è Editar</a>
                  <button type="button" onclick="abrirModalPago({{ cuenta.id }}, '{{ cuenta.factura or cuenta.id }}', {{ cuenta.monto_abonado or 0 }}, '{{ url_for("cuenta_a_pagar_agregar_pago", id=cuenta.id) }}')" 
                          style="padding: 4px 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">üí∞ Agregar Pago</button>
                  <form method="POST" action="{{ url_for('cuenta_a_pagar_eliminar', id=cuenta.id) }}" 
                        style="display: inline;" onsubmit="return confirm('¬øEst√° seguro de eliminar esta cuenta a pagar?');">
                    <button type="submit" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">üóëÔ∏è</button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
          
          {% if not cuentas %}
            <tr>
              <td colspan="20" style="text-align: center; padding: 40px; color: #999;">
                No hay cuentas a pagar registradas. <a href="{{ url_for('cuenta_a_pagar_nuevo') }}">Crear primera cuenta a pagar</a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {# Controles de paginaci√≥n #}
    {% if total_registros and total_registros > 0 %}
      <div class="paginacion">
        <div class="paginacion-info">
          <span>
            Mostrando {{ ((pagina - 1) * limite) + 1 }} - 
            {{ [pagina * limite, total_registros]|min }} de {{ total_registros }} registros
          </span>
          <span>
            P√°gina {{ pagina }} de {{ total_paginas }}
          </span>
        </div>
        <div class="paginacion-controls">
          <form method="GET" action="{{ url_for('cuentas_a_pagar_index') }}" style="display: flex; align-items: center; gap: 10px;">
            {# Mantener todos los filtros en los par√°metros ocultos #}
            {% if request.args.get('fecha_desde') %}
              <input type="hidden" name="fecha_desde" value="{{ request.args.get('fecha_desde') }}">
            {% endif %}
            {% if request.args.get('fecha_hasta') %}
              <input type="hidden" name="fecha_hasta" value="{{ request.args.get('fecha_hasta') }}">
            {% endif %}
            {% if request.args.get('proveedor') %}
              <input type="hidden" name="proveedor" value="{{ request.args.get('proveedor') }}">
            {% endif %}
            {% if request.args.get('estado') %}
              <input type="hidden" name="estado" value="{{ request.args.get('estado') }}">
            {% endif %}
            {% if request.args.get('banco_id') %}
              <input type="hidden" name="banco_id" value="{{ request.args.get('banco_id') }}">
            {% endif %}
            {% if request.args.get('cuenta_id') %}
              <input type="hidden" name="cuenta_id" value="{{ request.args.get('cuenta_id') }}">
            {% endif %}
            {% if request.args.get('saldo_filtro') %}
              <input type="hidden" name="saldo_filtro" value="{{ request.args.get('saldo_filtro') }}">
            {% endif %}
            {% if request.args.get('fecha_pago_desde') %}
              <input type="hidden" name="fecha_pago_desde" value="{{ request.args.get('fecha_pago_desde') }}">
            {% endif %}
            {% if request.args.get('fecha_pago_hasta') %}
              <input type="hidden" name="fecha_pago_hasta" value="{{ request.args.get('fecha_pago_hasta') }}">
            {% endif %}
            {% if request.args.get('plano_cuenta') %}
              <input type="hidden" name="plano_cuenta" value="{{ request.args.get('plano_cuenta') }}">
            {% endif %}
            <label style="font-size: 0.9em; font-weight: 600;">Filas por p√°gina:</label>
            <select name="limite" onchange="this.form.submit()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
              <option value="25" {% if limite == 25 %}selected{% endif %}>25</option>
              <option value="50" {% if limite == 50 %}selected{% endif %}>50</option>
              <option value="100" {% if limite == 100 %}selected{% endif %}>100</option>
              <option value="200" {% if limite == 200 %}selected{% endif %}>200</option>
            </select>
            <input type="hidden" name="pagina" value="1">
          </form>
        </div>
        <div class="paginacion-buttons">
          {% if pagina > 1 %}
            <a href="{{ url_for('cuentas_a_pagar_index', pagina=pagina-1, limite=limite, fecha_desde=request.args.get('fecha_desde', ''), fecha_hasta=request.args.get('fecha_hasta', ''), proveedor=request.args.get('proveedor', ''), estado=request.args.get('estado', ''), banco_id=request.args.get('banco_id', ''), cuenta_id=request.args.get('cuenta_id', ''), saldo_filtro=request.args.get('saldo_filtro', ''), fecha_pago_desde=request.args.get('fecha_pago_desde', ''), fecha_pago_hasta=request.args.get('fecha_pago_hasta', ''), plano_cuenta=request.args.get('plano_cuenta', '')) }}">
              ‚Üê Anterior
            </a>
          {% else %}
            <button disabled>‚Üê Anterior</button>
          {% endif %}
          
          {% if pagina < total_paginas %}
            <a href="{{ url_for('cuentas_a_pagar_index', pagina=pagina+1, limite=limite, fecha_desde=request.args.get('fecha_desde', ''), fecha_hasta=request.args.get('fecha_hasta', ''), proveedor=request.args.get('proveedor', ''), estado=request.args.get('estado', ''), banco_id=request.args.get('banco_id', ''), cuenta_id=request.args.get('cuenta_id', ''), saldo_filtro=request.args.get('saldo_filtro', ''), fecha_pago_desde=request.args.get('fecha_pago_desde', ''), fecha_pago_hasta=request.args.get('fecha_pago_hasta', ''), plano_cuenta=request.args.get('plano_cuenta', '')) }}">
              Siguiente ‚Üí
            </a>
          {% else %}
            <button disabled>Siguiente ‚Üí</button>
          {% endif %}
        </div>
      </div>
    {% endif %}
  </div>

  <!-- Modal de Previsualizaci√≥n -->
  <div id="modalPrevisualizacion" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
    <div style="background: white; margin: 50px auto; max-width: 95%; max-height: 90vh; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">üìã Previsualizaci√≥n de Importaci√≥n CSV</h2>
        <button onclick="cerrarModal()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 18px;">‚úï</button>
      </div>
      
      <div id="resumenPrevisualizacion" style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <p><strong>Total de filas:</strong> <span id="totalFilas">0</span></p>
        <p><strong>Filas v√°lidas:</strong> <span id="filasValidas" style="color: green;">0</span></p>
        <p><strong>Filas con errores:</strong> <span id="filasInvalidas" style="color: red;">0</span></p>
      </div>
      
      <div style="max-height: 60vh; overflow-y: auto; margin-bottom: 20px;">
        <table class="cuentas-table" style="font-size: 0.75em;">
          <thead>
            <tr>
              <th>Fila</th>
              <th>Estado</th>
              <th>Fecha Emisi√≥n</th>
              <th>Medio de Pago</th>
              <th>Cuenta</th>
              <th>Proveedor</th>
              <th>Valor</th>
              <th>Vencimiento</th>
              <th>Errores</th>
            </tr>
          </thead>
          <tbody id="tablaPrevisualizacion">
            <!-- Se llenar√° din√°micamente -->
          </tbody>
        </table>
      </div>
      
      <div id="erroresResumen" style="background: #ffebee; padding: 15px; border-radius: 6px; margin-bottom: 20px; max-height: 200px; overflow-y: auto; display: none;">
        <h3 style="margin-top: 0; color: #c62828;">Errores encontrados:</h3>
        <ul id="listaErrores" style="margin: 0; padding-left: 20px;">
          <!-- Se llenar√° din√°micamente -->
        </ul>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="cerrarModal()" style="background: #757575; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancelar</button>
        <button onclick="confirmarImportacion()" id="btnConfirmar" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">‚úì Confirmar e Importar</button>
      </div>
    </div>
  </div>

  <!-- Modal para Agregar Pago -->
  <div id="modalAgregarPago" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
    <div style="background: white; margin: 50px auto; max-width: 500px; border-radius: 8px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">üí∞ Agregar Pago</h2>
        <button onclick="cerrarModalPago()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 18px;">‚úï</button>
      </div>
      
      <div id="infoCuentaPago" style="background: #f9f9f9; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
        <p><strong>Cuenta:</strong> <span id="numeroCuentaPago"></span></p>
        <p><strong>Monto Abonado Actual:</strong> <span id="montoAbonadoActual"></span></p>
      </div>
      
      <form id="formAgregarPago" onsubmit="enviarPago(event)">
        <input type="hidden" id="cuentaIdPago" name="cuenta_id">
        <input type="hidden" id="urlAgregarPago" name="url">
        
        <div style="margin-bottom: 15px;">
          <label for="fecha_pago_modal" style="display: block; font-weight: 600; margin-bottom: 5px;">Fecha de Pago:</label>
          <input type="date" id="fecha_pago_modal" name="fecha_pago" required 
                 style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        </div>
        
        <div style="margin-bottom: 20px;">
          <label for="monto_pago_modal" style="display: block; font-weight: 600; margin-bottom: 5px;">Monto del Pago:</label>
          <input type="text" id="monto_pago_modal" name="monto_pago" required 
                 placeholder="0.00" 
                 style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" onclick="cerrarModalPago()" 
                  style="background: #757575; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Cancelar</button>
          <button type="submit" 
                  style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold;">Agregar Pago</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let datosPrevisualizacion = null;
    let cuentaIdActual = null;
    let urlAgregarPagoActual = null;
    
    function abrirModalPago(cuentaId, numeroCuenta, montoAbonado, url) {
      cuentaIdActual = cuentaId;
      urlAgregarPagoActual = url;
      
      document.getElementById('cuentaIdPago').value = cuentaId;
      document.getElementById('urlAgregarPago').value = url;
      document.getElementById('numeroCuentaPago').textContent = numeroCuenta;
      document.getElementById('montoAbonadoActual').textContent = new Intl.NumberFormat('es-PY', { 
        minimumFractionDigits: 2, 
        maximumFractionDigits: 2 
      }).format(montoAbonado || 0);
      
      // Establecer fecha de hoy por defecto
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('fecha_pago_modal').value = hoy;
      
      // Limpiar monto
      document.getElementById('monto_pago_modal').value = '';
      
      document.getElementById('modalAgregarPago').style.display = 'block';
    }
    
    function cerrarModalPago() {
      document.getElementById('modalAgregarPago').style.display = 'none';
      document.getElementById('formAgregarPago').reset();
    }
    
    function enviarPago(event) {
      event.preventDefault();
      
      const formData = new FormData(event.target);
      const url = urlAgregarPagoActual;
      
      // Mostrar indicador de carga
      const submitBtn = event.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = 'Procesando...';
      
      fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Pago agregado correctamente');
          cerrarModalPago();
          // Recargar la p√°gina para mostrar los cambios
          window.location.reload();
        } else {
          alert('Error: ' + (data.error || 'No se pudo agregar el pago'));
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      })
      .catch(error => {
        alert('Error al agregar pago: ' + error);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      });
    }
    
    // Cerrar modal al hacer clic fuera
    window.onclick = function(event) {
      const modal = document.getElementById('modalAgregarPago');
      if (event.target == modal) {
        cerrarModalPago();
      }
    }
    
    function importarCSV(input) {
      if (input.files && input.files[0]) {
        const formData = new FormData();
        formData.append('archivo_csv', input.files[0]);
        
        // Mostrar indicador de carga
        const modal = document.getElementById('modalPrevisualizacion');
        modal.style.display = 'block';
        document.getElementById('tablaPrevisualizacion').innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Cargando y validando datos...</td></tr>';
        
        fetch('{{ url_for("cuentas_a_pagar_previsualizar_csv") }}', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.error) {
            alert('Error: ' + data.error);
            cerrarModal();
            return;
          }
          
          datosPrevisualizacion = data;
          mostrarPrevisualizacion(data);
        })
        .catch(error => {
          alert('Error al previsualizar CSV: ' + error);
          cerrarModal();
        });
      }
    }
    
    function mostrarPrevisualizacion(data) {
      document.getElementById('totalFilas').textContent = data.total_filas;
      document.getElementById('filasValidas').textContent = data.filas_validas;
      document.getElementById('filasInvalidas').textContent = data.filas_invalidas;
      
      const tbody = document.getElementById('tablaPrevisualizacion');
      tbody.innerHTML = '';
      
      data.datos.forEach(fila => {
        const tr = document.createElement('tr');
        tr.style.backgroundColor = fila.valida ? '#e8f5e9' : '#ffebee';
        
        const estadoBadge = fila.valida 
          ? '<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">‚úì V√°lida</span>'
          : '<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">‚úó Error</span>';
        
        tr.innerHTML = `
          <td>${fila.fila}</td>
          <td>${estadoBadge}</td>
          <td>${fila.datos.fecha_emision || '-'}</td>
          <td>${fila.datos.documento || '-'}</td>
          <td>${fila.datos.cuenta || '-'}</td>
          <td>${fila.datos.proveedor || '-'}</td>
          <td>${fila.datos.valor || '-'}</td>
          <td>${fila.datos.vencimiento || '-'}</td>
          <td style="color: red; font-size: 0.7em;">${fila.errores.join('; ') || '-'}</td>
        `;
        tbody.appendChild(tr);
      });
      
      // Mostrar errores si hay
      if (data.errores && data.errores.length > 0) {
        const erroresDiv = document.getElementById('erroresResumen');
        erroresDiv.style.display = 'block';
        const listaErrores = document.getElementById('listaErrores');
        listaErrores.innerHTML = '';
        data.errores.forEach(error => {
          const li = document.createElement('li');
          li.textContent = error;
          li.style.marginBottom = '5px';
          listaErrores.appendChild(li);
        });
      } else {
        document.getElementById('erroresResumen').style.display = 'none';
      }
      
      // Deshabilitar bot√≥n de confirmar si no hay filas v√°lidas
      const btnConfirmar = document.getElementById('btnConfirmar');
      if (data.filas_validas === 0) {
        btnConfirmar.disabled = true;
        btnConfirmar.style.background = '#ccc';
        btnConfirmar.title = 'No hay filas v√°lidas para importar';
      } else {
        btnConfirmar.disabled = false;
        btnConfirmar.style.background = '#4CAF50';
        btnConfirmar.title = '';
      }
    }
    
    function cerrarModal() {
      document.getElementById('modalPrevisualizacion').style.display = 'none';
      datosPrevisualizacion = null;
      // Limpiar el input de archivo
      document.getElementById('importarCsvInput').value = '';
    }
    
    function confirmarImportacion() {
      if (!datosPrevisualizacion || datosPrevisualizacion.filas_validas === 0) {
        alert('No hay datos v√°lidos para importar');
        return;
      }
      
      if (!confirm(`¬øEst√° seguro de importar ${datosPrevisualizacion.filas_validas} cuenta(s) v√°lida(s)?`)) {
        return;
      }
      
      // Realizar la importaci√≥n
      fetch('{{ url_for("cuentas_a_pagar_importar_csv") }}', {
        method: 'POST'
      })
      .then(response => {
        if (response.redirected) {
          window.location.href = response.url;
        } else {
          return response.text();
        }
      })
      .catch(error => {
        alert('Error al importar: ' + error);
      });
    }
    
    // Cerrar modal al hacer clic fuera de √©l
    document.getElementById('modalPrevisualizacion').addEventListener('click', function(e) {
      if (e.target === this) {
        cerrarModal();
      }
    });
  </script>
{% endblock %}


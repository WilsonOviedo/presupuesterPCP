{% extends 'base.html' %}
{% block title %}Cuentas a Recibir{% endblock %}
{% block head %}
  <style>
    body {
      margin: 0 !important;
      padding: 0 !important;
    }
    .container {
      max-width: 100% !important;
      width: 100% !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    .filtros-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .filtros-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }
    .form-group input,
    .form-group select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .cuentas-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }
    .cuentas-table thead {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%) !important;
      color: white !important;
    }
    .cuentas-table thead th {
      background: transparent !important;
      color: white !important;
    }
    .cuentas-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .cuentas-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #e8e8e8;
      font-size: 0.85em;
    }
    .cuentas-table tbody tr {
      transition: background-color 0.2s ease;
    }
    .cuentas-table tbody tr:nth-child(even) {
      background: #fafafa;
    }
    .cuentas-table tbody tr:hover {
      background: #e0f2f1;
    }
    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
      display: inline-block;
    }
    .status-recibido {
      background: #d4edda;
      color: #155724;
    }
    .status-en-espera {
      background: #fff3cd;
      color: #856404;
    }
    .status-adelantado {
      background: #d1ecf1;
      color: #0c5460;
    }
    .status-atrasado {
      background: #f8d7da;
      color: #721c24;
    }
    .status-en-dia {
      background: #d4edda;
      color: #155724;
    }
    .valor-negativo {
      color: #d32f2f !important;
      font-weight: bold !important;
    }
  </style>
{% endblock %}
{% block content %}
  <div style="max-width: 100%; margin: 0; padding: 0;">
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <a class="button button-secondary" href="{{ url_for('financiero_index') }}">‚Üê Volver</a>
      </div>
      <div style="display: flex; gap: 10px;">
        <a class="button" href="{{ url_for('cuentas_a_recibir_exportar_csv', **request.args) }}" style="background: #4CAF50;">üì• Exportar CSV</a>
        <button type="button" class="button" onclick="document.getElementById('importarCsvInput').click()" style="background: #FF9800;">üì§ Importar CSV</button>
        <input type="file" id="importarCsvInput" accept=".csv" style="display: none;" onchange="importarCSV(this)">
        <a class="button" href="{{ url_for('cuenta_a_recibir_nuevo') }}" style="background: #009688;">‚ûï Nueva Cuenta a Recibir</a>
      </div>
    </div>

    <h2>üí∞ Cuentas a Recibir</h2>

    {% if error %}
      <div style="background: #ffebee; color: #c62828; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ef5350;">
        <strong>Error:</strong> {{ error }}
      </div>
    {% endif %}

    {% if mensaje %}
      <div style="background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #4caf50;">
        <strong>√âxito:</strong> {{ mensaje }}
      </div>
    {% endif %}

    <div class="filtros-section">
      <h3 style="margin-top: 0;">Filtros</h3>
      <form method="GET" action="{{ url_for('cuentas_a_recibir_index') }}">
        <div class="filtros-row">
          <div class="form-group">
            <label for="fecha_desde">Fecha desde:</label>
            <input type="date" id="fecha_desde" name="fecha_desde" value="{{ fecha_desde }}">
          </div>
          <div class="form-group">
            <label for="fecha_hasta">Fecha hasta:</label>
            <input type="date" id="fecha_hasta" name="fecha_hasta" value="{{ fecha_hasta }}">
          </div>
          <div class="form-group">
            <label for="cliente">Cliente:</label>
            <input type="text" id="cliente" name="cliente" value="{{ cliente_filtro }}" placeholder="Buscar cliente...">
          </div>
          <div class="form-group">
            <label for="estado">Estado:</label>
            <select id="estado" name="estado">
              <option value="">Todos</option>
              <option value="RECIBIDO" {% if estado_filtro == 'RECIBIDO' %}selected{% endif %}>Recibido</option>
              <option value="EN ESPERA" {% if estado_filtro == 'EN ESPERA' %}selected{% endif %}>En Espera</option>
            </select>
          </div>
          <div class="form-group">
            <label for="banco_id">Banco:</label>
            <select id="banco_id" name="banco_id">
              <option value="">Todos</option>
              {% for banco in bancos %}
                <option value="{{ banco.id }}" {% if banco_filtro == banco.id %}selected{% endif %}>{{ banco.nombre }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button type="submit" class="button" style="background: #009688;">üîç Buscar</button>
          <a href="{{ url_for('cuentas_a_recibir_index') }}" class="button button-secondary">Limpiar filtros</a>
        </div>
      </form>
    </div>

    <div style="overflow-x: auto;">
      <table class="cuentas-table">
        <thead>
          <tr>
            <th>Fecha Emisi√≥n</th>
            <th>Medio de Pago</th>
            <th>Cuenta</th>
            <th>Plano de Cuenta</th>
            <th>Proyecto</th>
            <th>Tipo</th>
            <th>Cliente</th>
            <th>Documento</th>
            <th>Descripci√≥n</th>
            <th>Banco</th>
            <th>Valor</th>
            <th>Cuotas</th>
            <th>Valor Cuota</th>
            <th>Vencimiento</th>
            <th>Fecha Recibo</th>
            <th>Estado</th>
            <th>Status Recibo</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for cuenta in cuentas %}
            <tr>
              <td>{{ cuenta.fecha_emision.strftime('%d/%m/%Y') if cuenta.fecha_emision else '-' }}</td>
              <td>{{ cuenta.documento_nombre or '-' }}</td>
              <td>{{ cuenta.cuenta_nombre or '-' }}</td>
              <td>{{ cuenta.plano_cuenta or '-' }}</td>
              <td>{{ cuenta.proyecto_nombre or '-' }}</td>
              <td>{{ cuenta.tipo or '-' }}</td>
              <td>{{ cuenta.cliente or '-' }}</td>
              <td>{{ cuenta.factura or '-' }}</td>
              <td>{{ cuenta.descripcion or '-' }}</td>
              <td>{{ cuenta.banco_nombre or '-' }}</td>
              <td style="text-align: right;" {% if cuenta.valor and cuenta.valor < 0 %}class="valor-negativo"{% endif %}>
                {% if cuenta.valor and cuenta.valor < 0 %}
                  ({{ "{:,.2f}".format(abs(cuenta.valor)) }})
                {% else %}
                  {{ "{:,.2f}".format(cuenta.valor) if cuenta.valor else '0.00' }}
                {% endif %}
              </td>
              <td>{{ cuenta.cuotas or '-' }}</td>
              <td style="text-align: right;" {% if cuenta.valor_cuota and cuenta.valor_cuota < 0 %}class="valor-negativo"{% endif %}>
                {% if cuenta.valor_cuota and cuenta.valor_cuota < 0 %}
                  ({{ "{:,.2f}".format(abs(cuenta.valor_cuota)) }})
                {% elif cuenta.valor_cuota %}
                  {{ "{:,.2f}".format(cuenta.valor_cuota) }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>{{ cuenta.vencimiento.strftime('%d/%m/%Y') if cuenta.vencimiento else '-' }}</td>
              <td>{{ cuenta.fecha_recibo.strftime('%d/%m/%Y') if cuenta.fecha_recibo else '-' }}</td>
              <td>
                <span class="status-badge status-{{ cuenta.estado.lower().replace(' ', '-') }}">
                  {{ cuenta.estado or '-' }}
                </span>
              </td>
              <td>
                {% if cuenta.status_recibo %}
                  <span class="status-badge status-{{ cuenta.status_recibo.lower().replace(' ', '-') }}">
                    {{ cuenta.status_recibo }}
                  </span>
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                <a href="{{ url_for('cuenta_a_recibir_editar', id=cuenta.id) }}" 
                   style="padding: 4px 8px; background: #009688; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8em;">‚úèÔ∏è Editar</a>
                <form method="POST" action="{{ url_for('cuenta_a_recibir_eliminar', id=cuenta.id) }}" 
                      style="display: inline;" onsubmit="return confirm('¬øEst√° seguro de eliminar esta cuenta a recibir?');">
                  <button type="submit" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">üóëÔ∏è</button>
                </form>
              </td>
            </tr>
          {% endfor %}
          
          {% if not cuentas %}
            <tr>
              <td colspan="18" style="text-align: center; padding: 40px; color: #999;">
                No hay cuentas a recibir registradas. <a href="{{ url_for('cuenta_a_recibir_nuevo') }}">Crear primera cuenta a recibir</a>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function importarCSV(input) {
      if (input.files && input.files[0]) {
        const formData = new FormData();
        formData.append('archivo_csv', input.files[0]);
        
        fetch('{{ url_for("cuentas_a_recibir_importar_csv") }}', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          if (response.redirected) {
            window.location.href = response.url;
          } else {
            return response.text();
          }
        })
        .catch(error => {
          alert('Error al importar CSV: ' + error);
        });
      }
    }
  </script>
{% endblock %}

